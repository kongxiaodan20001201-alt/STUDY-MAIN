# Java æ¶æ„å¸ˆå­¦ä¹ ç¬”è®°ï¼šåˆ†å¸ƒå¼äº‹åŠ¡ä¸ä¸€è‡´æ€§æ¶æ„

**æ—¥æœŸ**: 2026-01-10
**ä¸»é¢˜**: Zookeeper æ¶æ„ã€åˆ†å¸ƒå¼é” & Seata åˆ†å¸ƒå¼äº‹åŠ¡åŸç†
**çŠ¶æ€**: âœ… å·²å®Œæˆ

## ğŸ§  æ ¸å¿ƒçŸ¥è¯†ç‚¹å›é¡¾

### 1. Zookeeper ä¸ åˆ†å¸ƒå¼é” (CP æ¶æ„)
- **å®šä½**: ä¿è¯å¼ºä¸€è‡´æ€§ (CP)ï¼ŒLeader é€‰ä¸¾æœŸé—´ä¸å¯ç”¨ã€‚
- **åˆ†å¸ƒå¼é”åŸç†**:
  - åˆ©ç”¨ **ä¸´æ—¶é¡ºåºèŠ‚ç‚¹ + Watcher** å®ç°ã€‚
  - **ä¼˜åŠ¿**: é¿å… Redis çš„è‡ªæ—‹é” (Spin Lock) CPU æ¶ˆè€—ï¼Œç›‘å¬æœºåˆ¶å®ç°â€œå…¬å¹³é”â€å’Œâ€œé“¾å¼å”¤é†’â€ï¼ŒSession æ–­å¼€è‡ªåŠ¨é‡Šæ”¾é”ï¼ˆæ— æ­»é”ï¼‰ã€‚
  - **åŠ£åŠ¿**: å†™æ€§èƒ½ä¸å¦‚ Redisï¼Œé€‚ç”¨äºå¯¹æ•°æ®ä¸¥è°¨æ€§è¦æ±‚æé«˜çš„åœºæ™¯ã€‚

### 2. Seata AT æ¨¡å¼æ·±åº¦è§£å‰– (æ ¸å¿ƒ)
- **è®¾è®¡å“²å­¦**: **â€œå¿«é€Ÿé‡Šæ”¾æœ¬åœ°é”â€**ã€‚åˆ©ç”¨ Undo Log å’Œ å…¨å±€é”å®ç°é€»è¾‘å›æ»šï¼Œæ¢å–é«˜ååé‡ã€‚
- **ä¸¤é˜¶æ®µæµç¨‹**:
  - **Phase 1**: è§£æ SQL -> æŸ¥å‰é•œåƒ -> æ‰§è¡Œä¸šåŠ¡ -> æŸ¥åé•œåƒ -> è®° Undo Log -> **æ³¨å†Œåˆ†æ”¯ç”³è¯·å…¨å±€é”** -> æäº¤æœ¬åœ°äº‹åŠ¡ã€‚
  - **Phase 2 (Commit)**: æé€Ÿè¿”å›æˆåŠŸ -> å¼‚æ­¥åˆ é™¤ Undo Logã€‚
  - **Phase 2 (Rollback)**: æŸ¥å½“å‰æ•°æ®åšè„å†™æ ¡éªŒ -> æ ¹æ®å‰é•œåƒç”Ÿæˆåå‘ SQL -> æ¢å¤æ•°æ®ã€‚
- **å…¨å±€é” (Global Lock)**:
  - **ç²’åº¦**: è¡¨å + ä¸»é”®ã€‚
  - **ä½œç”¨**: å³ä½¿æœ¬åœ° DB é”å·²é‡Šæ”¾ï¼ŒTC ç«¯çš„å…¨å±€é”èƒ½æ‹¦æˆªå…¶ä»– Seata äº‹åŠ¡çš„å†™æ“ä½œï¼Œå®ç° **â€œè¯»æœªæäº¤(ç‰©ç†) + å†™éš”ç¦»(é€»è¾‘)â€**ã€‚
- **XID æœºåˆ¶**:
  - **äº§ç”Ÿæ—¶æœº**: **TM å¼€å¯äº‹åŠ¡æ—¶**ï¼ˆè¿›å…¥ `@GlobalTransactional` æ–¹æ³•å‰ï¼‰ã€‚
  - **ä¼ é€’**: é€šè¿‡ RPC/HTTP Header è‡ªä¸Šè€Œä¸‹é€ä¼ ã€‚

### 3. åˆ†å¸ƒå¼ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆåˆ†çº§ (æ¶æ„å¸ˆè§†è§’)
| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | æ ¸å¿ƒç†ç”± |
| :--- | :--- | :--- |
| **æ ¸å¿ƒäº¤æ˜“ (å¼ºä¸€è‡´)** | **Seata TCC** | èµ„é‡‘/åº“å­˜æ‰£å‡ã€‚æ€§èƒ½é«˜ï¼Œæ— é•¿é”ï¼Œä½†å¼€å‘æˆæœ¬é«˜ã€‚ |
| **é€šç”¨ä¸šåŠ¡ (å¸¸è§„)** | **Seata AT** | OA/ERP/æ™®é€šä¸‹å•ã€‚é›¶ä¾µå…¥å¼€å‘ï¼Œæ€§èƒ½é€‚ä¸­ã€‚ |
| **é™„å¸¦ä¸šåŠ¡ (æœ€ç»ˆä¸€è‡´)** | **æœ¬åœ°æ¶ˆæ¯è¡¨ + MQ** | **é€ç§¯åˆ†/å‘åˆ¸/é€šçŸ¥**ã€‚åˆ©ç”¨æœ¬åœ°äº‹åŠ¡åŸå­æ€§å†™å…¥ä»»åŠ¡ï¼Œå¼‚æ­¥è°ƒåº¦å‘ MQã€‚**ç”¨æˆ·ä½“éªŒæœ€å¥½**ï¼ˆæˆåŠŸæ‰å‘ï¼Œæ— å›æ»šè„æ•°æ®ï¼‰ã€‚ |

### 4. å¸¸è§é—®é¢˜ä¸é¿å‘
- **è„è¯»ç°è±¡**: Seata AT é»˜è®¤å…è®¸æ™®é€šæŸ¥è¯¢è¯»åˆ°ä¸­é—´çŠ¶æ€ã€‚è§£æ³•ï¼š`@GlobalLock` + `FOR UPDATE` (æŠ€æœ¯è§£) æˆ– å¼•å…¥â€œå†»ç»“ä¸­â€çŠ¶æ€ (ä¸šåŠ¡è§£)ã€‚
- **é•¿äº‹åŠ¡**: é¿å…åœ¨ `@GlobalTransactional` ä¸­è¿›è¡Œ RPC/Http è€—æ—¶è°ƒç”¨ï¼Œé˜²æ­¢é•¿æ—¶é—´å ç”¨å…¨å±€é”ã€‚
- **è°ƒç”¨é¡ºåº**: ä¸¥æ ¼ç»Ÿä¸€èµ„æºè°ƒç”¨é¡ºåºï¼ˆå¦‚å…ˆæ‰£åº“å­˜åæ‰£ç§¯åˆ†ï¼‰ä»¥é˜²æ­¢æ­»é”ã€‚

## ğŸ¨ æ ‡å‡†æ¶æ„å›¾ (Seata AT ä¸‹å•æµç¨‹)
```mermaid
sequenceDiagram
    autonumber
    actor User as ç”¨æˆ·
    participant TM as è®¢å•æœåŠ¡(TM)
    participant TC as Seata Server(TC)
    participant RM_Order as è®¢å•åº“ä»£ç†(RM)
    participant RM_Stock as åº“å­˜æœåŠ¡(RM)
    participant RM_Points as ç§¯åˆ†æœåŠ¡(RM)

    Note over TM, RM_Order: (é€šå¸¸åœ¨åŒä¸€ä¸ªå¾®æœåŠ¡è¿›ç¨‹ä¸­)

    %% --- Phase 1: ä¸šåŠ¡æ‰§è¡Œä¸åŠ é” ---
    User->>TM: æäº¤ä¸‹å•è¯·æ±‚
    
    rect rgb(240, 248, 255)
        Note right of TM: 0. å¼€å¯å…¨å±€äº‹åŠ¡
        TM->>TC: GlobalBegin (ç”³è¯· XID)
        TC-->>TM: è¿”å› XID (tx_123)
    end

    rect rgb(255, 250, 240)
        Note right of TM: 1. æ‰§è¡Œè®¢å•ä¸šåŠ¡
        TM->>RM_Order: åˆ›å»ºè®¢å• (Local Transaction)
        RM_Order->>RM_Order: è§£æ SQL & è®°å½• UndoLog
        RM_Order->>TC: registerBranch (ç”³è¯·å…¨å±€é”: order:1)
        TC-->>RM_Order: é”è·å–æˆåŠŸ
        RM_Order->>RM_Order: æäº¤æœ¬åœ°äº‹åŠ¡ (é‡Šæ”¾ DB è¿æ¥)
        RM_Order-->>TM: æ‰§è¡ŒæˆåŠŸ
    end

    rect rgb(255, 250, 240)
        Note right of TM: 2. è¿œç¨‹è°ƒç”¨åº“å­˜ (ä¼ é€’ XID)
        TM->>RM_Stock: æ‰£å‡åº“å­˜ (Header: XID)
        RM_Stock->>RM_Stock: è§£æ SQL & è®°å½• UndoLog
        RM_Stock->>TC: registerBranch (ç”³è¯·å…¨å±€é”: stock:1)
        TC-->>RM_Stock: é”è·å–æˆåŠŸ
        RM_Stock->>RM_Stock: æäº¤æœ¬åœ°äº‹åŠ¡ (é‡Šæ”¾ DB è¿æ¥)
        RM_Stock-->>TM: æ‰§è¡ŒæˆåŠŸ
    end

    rect rgb(255, 250, 240)
        Note right of TM: 3. è¿œç¨‹è°ƒç”¨ç§¯åˆ† (ä¼ é€’ XID)
        TM->>RM_Points: æ‰£å‡ç§¯åˆ† (Header: XID)
        RM_Points->>RM_Points: è§£æ SQL & è®°å½• UndoLog
        RM_Points->>TC: registerBranch (ç”³è¯·å…¨å±€é”: points:88)
        TC-->>RM_Points: é”è·å–æˆåŠŸ
        RM_Points->>RM_Points: æäº¤æœ¬åœ°äº‹åŠ¡ (é‡Šæ”¾ DB è¿æ¥)
        RM_Points-->>TM: æ‰§è¡ŒæˆåŠŸ
    end

    %% --- Phase 2: æé€Ÿæäº¤ ---
    rect rgb(220, 255, 220)
        Note right of TM: Phase 2: å¼‚æ­¥æäº¤
        TM->>TC: GlobalCommit (æäº¤ XID: tx_123)
        TC-->>TM: æäº¤æˆåŠŸ (çŠ¶æ€è½ç›˜)
        TM-->>User: ä¸‹å•æˆåŠŸ (æ— éœ€ç­‰å¾…æ¸…ç†)
    end

    %% --- å¼‚æ­¥æ¸…ç† ---
    TC-)RM_Order: BranchCommit (æ¸…ç†æ—¥å¿—)
    TC-)RM_Stock: BranchCommit (æ¸…ç†æ—¥å¿—)
    TC-)RM_Points: BranchCommit (æ¸…ç†æ—¥å¿—)
```