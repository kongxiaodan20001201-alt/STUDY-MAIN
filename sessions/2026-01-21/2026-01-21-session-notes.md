
# 📅 Java 架构师学习日志：微服务核心三件套

**日期**: 2026-02-21
**模块**: D. 微服务架构 (Microservices Architecture)
**今日进度**: Nacos (复盘) -> OpenFeign (RPC) -> Sentinel (容错)
**状态**: 🚀 核心组件闭环

---

## 🏛️ 第一部分：Nacos (注册与配置中心)

> **核心定位**：微服务的“电话本”和“档案馆”。

### 1. 架构心智模型：一楼与二楼

Nacos 是一个“缝合怪”，一套系统包含两个完全独立的逻辑：

| 维度 | **注册中心 (Naming)** | **配置中心 (Config)** |
| --- | --- | --- |
| **比喻** | **一楼大厅 (点名)** | **二楼档案室 (发文)** |
| **一致性目标** | **AP (高可用)**：活着最重要 | **CP (强一致)**：准确最重要 |
| **核心协议** | **Distro** (自研)：分片、异步复制 | **Raft** (标准)：选举、过半写入 |
| **存储介质** | **内存** (Map) + 本地快照 | **MySQL** (主) + 本地磁盘 (备) |
| **交互模式** | 客户端 **心跳** (5s/次) | 服务端 **长轮询** (Hold 29.5s) |

### 2. 源码级黑科技 (面试必考)

* **写时复制 (CopyOnWrite)**：
* **原理**：更新注册列表时，先 Clone 一份副本修改，改完瞬间替换引用。
* **价值**：实现**读操作完全无锁**，极致的读性能。


* **长轮询 (Long Polling)**：
* **原理**：利用 Servlet 3.0 异步特性，将请求挂起。
* **价值**：兼顾了 Push 的**实时性**和 Pull 的**低消耗**。



---

## 📞 第二部分：OpenFeign (RPC 通信)

> **核心定位**：声明式 HTTP 客户端，让远程调用像本地方法一样简单。

### 1. 底层原理：JDK 动态代理

* **流程**：
1. **启动**：Spring 扫描 `@FeignClient` -> 生成 **Proxy 代理对象**。
2. **调用**：拦截接口方法 -> 解析注解 (URL/参数)。
3. **组装**：通过 **RequestTemplate** 构建 HTTP 请求。
4. **寻址**：通过 **LoadBalancer** 查找 Nacos 缓存，选取真实 IP。
5. **发送**：交给底层客户端执行。



### 2. 生产环境避坑指南 (必做) ⚠️

默认配置仅为了“能跑”，生产上线必须优化：

1. **替换底层客户端 (Connection Pool)**
* **原罪**：默认 `HttpURLConnection` 无连接池，每次请求都 3次握手+4次挥手。
* **优化**：引入 `HttpClient` 或 `OkHttp`。
* **收益**：QPS 提升 50% 以上。


2. **日志级别 (Log Level)**
* **优化**：设为 `BASIC` 或 `NONE`。
* **禁忌**：严禁生产环境开 `FULL`，I/O 会拖垮 CPU。


3. **超时时间 (Timeout)**
* **优化**：调大 `readTimeout`，防止大业务执行时被意外断开。



---

## 🛡️ 第三部分：Sentinel (服务容错)

> **核心定位**：微服务的“防弹衣”，防止雪崩效应。

### 1. 防雪崩三板斧

| 机制 | 形象比喻 | 触发条件 | 结果 |
| --- | --- | --- | --- |
| **限流** | **地铁安检** | QPS > 阈值 | **直接拒绝**，保护系统。 |
| **熔断** | **保险丝** | 错误率高 / **响应太慢** | **暂时切断**，快速失败，防止线程堆积。 |
| **降级** | **备用胎** | 熔断后 / 主动开关 | 执行 `fallback` 方法，保证业务不报错。 |

### 2. 核心算法深度解析

* **预热 (Warm Up) - 防止冷启动崩溃**
* **底层算法**：**令牌桶 (Token Bucket)**。
* **爬坡原理**：
* **反向逻辑**：桶满 = 系统冷。
* **实现**：当令牌多时，**人为放大**获取令牌的成本（增加等待时间）。随着令牌被消耗，成本线性降低。
* **效果**：QPS 从 `阈值/3` 缓慢爬升至 `阈值`。


* **目的**：给 JVM (JIT 编译)、连接池初始化争取时间。


* **对比：滑动时间窗口 vs 令牌桶**
* **滑动窗口**：控制**数量** (Counter)。尺子，宏观统计。
* **令牌桶**：控制**速率** (Pacer)。水龙头，微观整形。
* *Sentinel 是两者的结合体。*



### 3. 规则持久化 (Push 模式) ⚠️

* **隐患**：Sentinel 默认规则在内存中，**重启即丢失**。
* **方案**：**Sentinel + Nacos**。
* 在 Nacos 配置 JSON 规则。
* Sentinel 监听变更并更新本地内存。
* **结果**：重启不丢数据，运维统一管理。



---

## 📝 明日计划 (D.23)

**API 网关 (Spring Cloud Gateway)**

* **统一入口**：微服务不再裸奔。
* **统一鉴权**：登录校验 (JWT) 怎么在网关层做？
* **全局过滤**：如何实现黑名单和日志拦截？

**(请注意休息，明天继续攻克网关！)**