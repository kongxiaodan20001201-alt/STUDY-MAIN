# 📅 Java 架构师学习日志：微服务架构完整闭环

**日期**: 2026-02-21
**模块**: D. 微服务架构 (Microservices Architecture)
**今日进度**: OpenFeign -> Sentinel -> Gateway -> SkyWalking
**状态**: ✅ D 模块核心组件通关

---

## 📞 1. OpenFeign：RPC 通信 (怎么打电话)

> **核心定位**：基于接口的声明式 HTTP 客户端。

* **底层原理**：**JDK 动态代理**。
* Spring 启动时扫描 `@FeignClient` 接口，生成代理对象 (Proxy)。
* 调用时拦截请求，通过 `RequestTemplate` 组装 URL，配合 LoadBalancer 选择 IP 发送。


* **生产避坑 (关键)**：
* **问题**：默认使用 JDK 的 `HttpURLConnection`，无连接池，高并发下频繁握手挥手会耗尽资源。
* **解决**：必须引入 `HttpClient` 或 `OkHttp` 依赖，开启**连接池 (Connection Pool)**。
* **日志**：生产环境严禁开启 `FULL` 日志，应设为 `BASIC` 或 `NONE`。



---

## 🛡️ 2. Sentinel：服务容错 (怎么防雪崩)

> **核心定位**：流量防暴警察，微服务的“防弹衣”。

### A. 三大核心机制

| 机制 | 作用 | 触发场景 |
| --- | --- | --- |
| **限流 (Flow Control)** | 也就是"拒之门外" | QPS 超过设定阈值。 |
| **熔断 (Circuit Breaking)** | 也就是"暂时断交" | 错误率高，或**响应时间太慢 (慢调用)**。 |
| **降级 (Degradation)** | 也就是"备用方案" | 熔断后执行 `fallback` 方法，保证业务可用。 |

### B. 核心算法深度解析 (面试必杀技)

* **预热 (Warm Up) 原理**：
* **场景**：防止冷系统（未 JIT 编译、连接池为空）被瞬间洪峰打死。
* **算法**：**令牌桶 (Token Bucket)**。
* **逻辑**：桶满 = 系统冷。**人为拉长**拿令牌的时间，随着令牌消耗，QPS 像爬坡一样线性上升。


* **滑动窗口 vs 令牌桶**：
* **滑动窗口**：关注 **“数量” (Counter)**。宏观限流（尺子）。
* **令牌桶**：关注 **“速率” (Rate)**。微观整形（水龙头）。Sentinel 结合了两者。



### C. 规则持久化

* Sentinel 默认规则在内存，**重启即丢失**。必须通过 **Nacos Push 模式** 实现持久化。

---

## 🚪 3. Spring Cloud Gateway：API 网关 (怎么守大门)

> **核心定位**：统一入口、鉴权、路由。

* **技术选型**：
* **Zuul 1.x**：阻塞 I/O (Servlet)，一请求一线程，高并发性能差。
* **Gateway**：**非阻塞 I/O (Netty + Reactor)**，少线程处理大并发，性能强劲。


* **核心三要素**：
* **路由 (Route)**：发往哪里 (Nacos 服务名)。
* **断言 (Predicate)**：匹配条件 (Path, Method)。
* **过滤器 (Filter)**：处理逻辑 (鉴权, 限流)。


* **生命周期**：
* **Pre Filter**：转发**前**执行。核心场景：**统一鉴权 (Token 校验)**、参数清洗。
* **Post Filter**：转发**后**执行。核心场景：统计接口耗时、统一响应包装。



---

## 🕵️ 4. SkyWalking：链路追踪 (怎么查问题)

> **核心定位**：微服务架构的“天眼”和“神探”。

* **核心概念**：
* **TraceId**：标记**整个请求链路** (串起网关、订单、数据库)。
* **SpanId**：标记**单个操作节点** (用于画树状拓扑图)。


* **实现原理**：**Java Agent (字节码增强)**。
* **非侵入式**：无需修改代码，启动命令加 `-javaagent` 即可。


* **性能影响 (架构师视角)**：
* **启动时**：变慢 10%-20% (类加载时插桩)。
* **运行时**：QPS 损耗极低 (1%-3%)。因为采用**异步非阻塞**方式上报数据，且 Agent 挂了不影响业务运行。



---

## 🔮 下一步计划 (E 模块)

**目标**：**分布式消息队列 (RocketMQ)**

微服务除了同步通信 (Feign)，还需要异步解耦 (MQ)。

* **场景**：下单后异步发短信、送积分。
* **挑战**：如何保证消息不丢失？如何保证最终一致性（分布式事务）？如何处理消息积压？

**(请好好休息，明天我们将探索阿里系的中间件王者——RocketMQ！)**